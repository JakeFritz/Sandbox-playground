name: Mirror to Gitlab to trigger CI

on:
  push:
  pull_request_target:
  schedule:
    - cron: '1 5 2 * *'

jobs:
  check_permission:
    runs-on: ubuntu-latest
    # if: github.repository_owner == 'Parallel-in-Time'
    steps:
      - name: Query permissions of triggering actor
        id: query_permission_triggering_actor
        if: github.event_name == 'pull_request_target'
        uses: actions-cool/check-user-permission@v2
        with:
          username: ${{ github.triggering_actor }}
          require: 'write'
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Interpret the queried result
        if: github.event_name == 'pull_request_target'
        run: |
          echo "Current permission level is ${{ steps.query_permission_triggering_actor.outputs.user-permission }}"
          echo "Job originally triggered by ${{ github.actor }}"
          if [ ${{ steps.query_permission_triggering_actor.outputs.require-result }} = 'admin' || ${{ steps.query_permission_triggering_actor.outputs.require-result }} = 'write' ]
            then
              echo 'Permissions granted'
              exit 0
            else
              echo 'Not enough permissions'
              exit 1
          fi
      - name: Pass if workflow from push or schedule
        if: >-
          (github.event_name == 'push') ||
          (github.event_name == 'schedule')
        run: exit 0
      - name: Fail for other triggers
        if: >-
          (github.event_name != 'push') &&
          (github.event_name != 'schedule') &&
          (github.event_name != 'pull_request_target')
        run: exit 1

  mirror_to_gitlab:
    runs-on: ubuntu-latest
    # if: ${{ github.repository_owner == 'Parallel-in-Time'}}
    needs:
      - check_permission
    steps:
      - name: Checkout
        uses: actions/checkout@v1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Mirror and wait for Gitlab-CI
        run: echo "Mirroring takes place here"
